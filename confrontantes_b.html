<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Indicações Fiscais de Confrontantes</title>

  <script src="lib/leaflet/leaflet.js"></script>
  <link href="lib/leaflet/leaflet.css" rel="stylesheet">
  <script src="lib/leaflet/esri-leaflet.js"></script>
  <script src="lib/leaflet/esri-leaflet-vector.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    @page { size: A4 portrait; margin: 10mm; }
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; font-size: 12px; color: black; }

    .pagina {
      width: 210mm; height: 297mm; box-sizing: border-box; border: 1px solid black;
      display: flex; flex-direction: column; justify-content: space-between; page-break-after: always;
    }

    .cabecalho { border-bottom: 1px solid black; padding: 5px 8px; }
    .cabecalho-superior { display: flex; align-items: center; justify-content: space-between; font-size: 11px; }
    .cabecalho-superior img { height: 35px; }
    .titulo { text-align: center; font-weight: bold; border-bottom: 1px solid black; padding: 4px; }
    .texto { padding: 4px 8px; border-bottom: 1px solid black; font-size: 11px; }
    .rodape { border-top: 1px solid black; text-align: center; font-size: 11px; font-weight: bold; padding: 3px; }

    .areaQuadro { flex: 1; display: flex; align-items: center; justify-content: center; padding: 5px; box-sizing: border-box; }
    .quadro { display: flex; border: 1px solid #ccc; }
    .mapa { width: 160mm; height: 250mm; border-right: 1px solid #ccc; }
    .painel { width: 50mm; height: 250mm; padding: 5px; overflow-y: auto; box-sizing: border-box; }

    .tituloPainel { display: flex; align-items: center; gap: 6px; margin: 6px 0; }
    .caixaLegenda { width: 14px; height: 14px; border: 2px solid; display:inline-block; vertical-align:middle; margin-right:6px; }
    .caixaLote { background-color: darkgray; border-color: black; }
    .caixaConfrontantes { background-color: rgba(0,0,139,0.1); border-color: darkblue; }

    .loteTooltip {
      background: transparent!important; border: none!important; box-shadow: none!important;
      font-size: 16px; font-weight: bold; color: black;
    }

    .registro { border-bottom: 1px solid #ccc; margin-bottom: 6px; padding-bottom: 4px; font-size: 12px; line-height: 1.3em; }
    .registro strong { display: block; margin-bottom: 2px; }
    .legenda-mapa { position: absolute; left:8px; bottom:8px; background:#fff; padding:6px; border:1px solid #ccc; font-size:11px; }
  </style>
</head>

<body>
  <div id="container"></div>

  <script>
    const urlMalha = "https://arcgis.itajai.sc.gov.br/server/rest/services/malha_cadastral_raster/FeatureServer/0";
    const urlImoveis = "https://arcgis.itajai.sc.gov.br/server/rest/services/Hosted/imoveis_plantacadastral/FeatureServer/0/";
    const MAX_VIZINHOS_POR_QUADRO = 6;

    // ler inscrição do hash
    const inscrlig = window.location.hash.length > 1 ? window.location.hash.substring(1) : null;
    if (!inscrlig) {
      alert("Adicione o número da inscrição ao final do endereço, ex: consulta.html#i005473010090");
      throw new Error("Inscrição não informada.");
    }

    // consulta lote
    L.esri.query({ url: urlMalha })
      .where(`inscrlig='${inscrlig}'`)
      .run((err, fc) => {
        if (err || !fc.features || fc.features.length === 0) {
          alert("Inscrição não encontrada na base cadastral.");
          return;
        }

        const lote = fc.features[0];
        const idLote = lote.properties.objectid;
        const buffer = turf.buffer(lote, 0.5, { units: "meters" });

        // busca vizinhos que intersectem o buffer — aceita qualquer interseção
        L.esri.query({ url: urlMalha })
          .intersects(buffer)
          .run((err2, vizinhos) => {
            if (err2) {
              console.error("Erro consulta vizinhos:", err2);
              return;
            }

            const vizinhosValidos = (vizinhos.features || []).filter(f => {
              if (f.properties.objectid === idLote) return false;
              try {
                return !!turf.intersect(buffer, f); // qualquer interseção
              } catch (e) {
                console.warn("intersect falhou para objectid", f.properties.objectid, e);
                return false;
              }
            });

            const inscrSelecionado = lote.properties.inscrlig;
            const inscrVizinhos = vizinhosValidos.map(f => `'${f.properties.inscrlig}'`).join(",");
            const inscrTodos = `'${inscrSelecionado}'` + (inscrVizinhos ? `,${inscrVizinhos}` : "");

            // consulta informações dos contribuintes
            L.esri.query({ url: urlImoveis })
              .where(`inscrlig IN (${inscrTodos})`)
              .run((err3, fcImoveis) => {
                if (err3 || !fcImoveis.features || fcImoveis.features.length === 0) {
                  // mesmo sem info de contribuinte, prosseguir com visualização dos polígonos
                  montarRelatorio(lote, vizinhosValidos, {});
                  return;
                }

                const dicContrib = {};
                const agrupados = {};
                fcImoveis.features.forEach(f => {
                  const insc = f.properties.inscrlig;
                  if (!agrupados[insc]) agrupados[insc] = [];
                  agrupados[insc].push(f.properties);
                });
                Object.keys(agrupados).forEach(insc => {
                  const registros = agrupados[insc];
                  const titularSim = registros.find(r => r.titular && r.titular.toString().trim().toUpperCase() === "SIM");
                  const selecionado = titularSim || registros[0];
                  dicContrib[insc] = selecionado?.nome_contribuinte || "-";
                });

                montarRelatorio(lote, vizinhosValidos, dicContrib);
              });
          });
      });

    function montarRelatorio(lote, vizinhosValidos, dicContrib) {
      // ordenar por ângulo
      const listaSequencial = ordenarVizinhosPorAngulo(lote, vizinhosValidos, 1);

      // agrupar em quadros com MAX_VIZINHOS_POR_QUADRO
      const grupos = [];
      for (let i = 0; i < listaSequencial.length; i += MAX_VIZINHOS_POR_QUADRO)
        grupos.push(listaSequencial.slice(i, i + MAX_VIZINHOS_POR_QUADRO));

      let contadorGlobal = 1;
      grupos.forEach((grupo, i) => {
        criarPagina(lote, grupo, dicContrib, i + 1, contadorGlobal, false);
        contadorGlobal += grupo.length;
      });

      // criar página final somente se houver mais de uma página (i.e., múltiplos quadros)
      if (grupos.length > 1) {
        criarPagina(lote, vizinhosValidos, dicContrib, grupos.length + 1, null, true);
      }

      // se não houve grupos (sem vizinhos), criar uma página apenas com o lote
      if (grupos.length === 0) {
        criarPagina(lote, [], dicContrib, 1, 1, false);
      }
    }

    function ordenarVizinhosPorAngulo(lote, vizinhos, passoGraus) {
      const centro = turf.centroid(lote);
      const coordCentro = centro.geometry.coordinates;
      const lista = [];
      const ids = new Set();
      const alcance = 2000;

      for (let ang = 0; ang < 360; ang += passoGraus) {
        const destino = turf.destination(centro, alcance, ang, { units: "meters" });
        const linha = turf.lineString([coordCentro, destino.geometry.coordinates]);
        for (const v of vizinhos) {
          try {
            const inter = turf.lineIntersect(linha, v);
            if (inter.features.length > 0) {
              const idv = v.properties.objectid;
              if (!ids.has(idv)) {
                lista.push(v);
                ids.add(idv);
              }
            }
          } catch (e) {}
        }
      }
      const final = [];
      const vistos = new Set();
      for (const v of lista) {
        const id = v.properties.objectid;
        if (!vistos.has(id)) {
          final.push(v);
          vistos.add(id);
        }
      }
      return final;
    }

    function criarPagina(lote, vizinhosGrupo, dicContrib, indiceQuadro, contadorInicial, paginaFinal) {
      const container = document.getElementById("container");
      const pagina = document.createElement("div");
      pagina.className = "pagina";
      pagina.innerHTML = `
        <div class="cabecalho">
          <div class="cabecalho-superior">
            <div><img src="images/brasao_municipio.png" alt="Logo Itajaí" onerror="this.style.display='none'"></div>
            <div>
              <b>PREFEITURA MUNICIPAL DE ITAJAÍ - SC</b><br>
              Secretaria Municipal da Fazenda<br>
              Departamento de Cadastro Técnico
            </div>
            <div><b>Data:</b> ${new Date().toLocaleDateString("pt-BR")}</div>
          </div>
        </div>
        <div class="titulo">CONSULTA DE INDICAÇÕES FISCAIS DE CONFRONTANTES</div>
        <div class="texto">
          Consulta gerada nos termos da Ação Conjunta SEDUH – SEFAZ, nº xx/2025.<br>
          Considera os dados da base cadastral georreferenciada na data de sua emissão, disponível em:<br>
          <a href="https://plantacadastral.itajai.sc.gov.br/" target="_blank" rel="noopener noreferrer">https://plantacadastral.itajai.sc.gov.br/</a><br>
          Os dados coletados têm finalidade tributária.<br>
          O presente documento e suas informações não constituem prova ou reconhecimento de direito de propriedade.
        </div>
        <div class="rodape">CROQUI DE LOCALIZAÇÃO E CONFRONTANTES</div>
        <div class="areaQuadro" id="areaQuadro_${indiceQuadro}"></div>
      `;
      container.appendChild(pagina);

      const area = pagina.querySelector(`#areaQuadro_${indiceQuadro}`);
      const quadroDiv = document.createElement("div");
      quadroDiv.className = "quadro";

      const mapaDiv = document.createElement("div");
      mapaDiv.id = "mapa_" + indiceQuadro;
      mapaDiv.className = "mapa";

      const painelDiv = document.createElement("div");
      painelDiv.className = "painel";

      if (paginaFinal) {
        painelDiv.innerHTML = `
          <div class="tituloPainel"><div class="caixaLegenda caixaLote"></div>
          <h3 style="margin:0">Lote Selecionado</h3></div>
          <div id="loteSel_${indiceQuadro}"></div>
        `;
      } else {
        painelDiv.innerHTML = `
          <div class="tituloPainel"><div class="caixaLegenda caixaLote"></div>
          <h3 style="margin:0">Lote Selecionado</h3></div>
          <div id="loteSel_${indiceQuadro}"></div>
          <div class="tituloPainel"><div class="caixaLegenda caixaConfrontantes"></div>
          <h3 style="margin:0">Confrontantes</h3></div>
          <div id="listaVizinhos_${indiceQuadro}"></div>
        `;
      }

      quadroDiv.appendChild(mapaDiv);
      quadroDiv.appendChild(painelDiv);
      area.appendChild(quadroDiv);

      criarMapa(lote, vizinhosGrupo, dicContrib, indiceQuadro, contadorInicial, paginaFinal);
    }

    function criarMapa(lote, vizinhosGrupo, dicContrib, indiceQuadro, contadorInicial, paginaFinal) {
      const mapa = L.map("mapa_" + indiceQuadro, {
        attributionControl: false,
        zoomControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        touchZoom: false
      }).setView([-26.9046, -48.6874], 16);

      // camada base vetorial ESRI (mantive ID conforme seu exemplo)
      L.esri.Vector.vectorTileLayer("7a110ef9198540068341e6908c6bf298", {
        portalUrl: "https://arcgis.itajai.sc.gov.br/portal",
        attribution: "Prefeitura de Itajaí"
      }).addTo(mapa);

      const loteLayer = L.geoJSON(lote, {
        style: { color: "black", weight: 4, fillColor: "darkgray", fillOpacity: 0.5 },
        onEachFeature: (f, l) => {
          l.bindTooltip("LOTE", { permanent: true, direction: "center", className: "loteTooltip" });
        }
      }).addTo(mapa);

      let contador = contadorInicial || 1;
      let listaHTML = "";

      const vizLayer = L.geoJSON(vizinhosGrupo, {
        style: { color: "darkblue", weight: 2, fillOpacity: 0.1 },
        onEachFeature: (f, l) => {
          if (!paginaFinal) {
            const num = contador;
            l.bindTooltip(num.toString(), { permanent: true, direction: "center", className: "loteTooltip" });
            const p = f.properties || {};
            listaHTML += `
              <div class="registro">
                <strong>#${num} - ${dicContrib[p.inscrlig] || "-"}</strong>
                <strong>Inscrição:</strong> ${p.inscricao || p.inscrlig || "-"}<br>
                <strong>Endereço:</strong> ${p.nomevia || "-"}, nº ${p.numero || "-"}
              </div>`;
            contador++;
          }
        }
      }).addTo(mapa);

      if (!paginaFinal) {
        const listaEl = document.getElementById(`listaVizinhos_${indiceQuadro}`);
        if (listaEl) listaEl.innerHTML = listaHTML;
      }

      const loteSelEl = document.getElementById(`loteSel_${indiceQuadro}`);
      if (loteSelEl) {
        const p = lote.properties || {};
        loteSelEl.innerHTML = `
          <div class="registro">
            <strong>${dicContrib[p.inscrlig] || "-"}</strong>
            <strong>Inscrição:</strong> ${p.inscricao || p.inscrlig || "-"}<br>
            <strong>Endereço:</strong> ${p.nomevia || "-"}, nº ${p.numero || "-"}
          </div>`;
      }

      const group = paginaFinal ? L.featureGroup([loteLayer, vizLayer]) : L.featureGroup([vizLayer]);
      try {
        if (group.getBounds && group.getBounds().isValid()) {
          mapa.fitBounds(group.getBounds(), { padding: [30, 30], maxZoom: 19 });
        } else {
          // fallback para lote
          const b = L.geoJSON(lote).getBounds();
          if (b.isValid()) mapa.fitBounds(b, { padding: [30,30], maxZoom: 19 });
        }
      } catch (e) {
        console.warn("Erro ao ajustar bounds:", e);
      }

      // norte fixo
      const norte = L.control({ position: 'topright' });
      norte.onAdd = () => {
        const div = L.DomUtil.create('div', 'info2 legend');
        div.innerHTML = '<center><sub><font size="6">▲</font></sub><br/><sup><font size="4">N</font></sup></center>';
        return div;
      };
      norte.addTo(mapa);

      // garantir redraw
      setTimeout(() => { try { mapa.invalidateSize(); } catch (e){} }, 200);
    }
  </script>
</body>
</html>
