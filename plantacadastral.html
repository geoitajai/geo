<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <title>Planta Cadastral</title>
    <link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <!-- jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <!-- jQuery UI -->
    <link href="lib/jquery-ui.min.css" rel="stylesheet">
    <link href="lib/jquery-ui.theme.min.css" rel="stylesheet">
    <script src="lib/jquery-ui.min.js"></script>
    <!-- Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha384-VzLXTJGPSyTLX6d96AxgkKvE/LRb7ECGyTxuwtpjHnVWVZs2gp5RDjeM/tgBnVdM" crossorigin="anonymous" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha384-RFZC58YeKApoNsIbBxf4z6JJXmh+geBSgkCQXFyh+4tiFSJmJBt+2FbjxW7Ar16M"
        crossorigin="anonymous"></script>
    <!-- Tabulator from CDN -->
    <link href="https://unpkg.com/tabulator-tables@5.2.4/dist/css/tabulator_simple.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.2.4/dist/js/tabulator.min.js"></script>
    <!-- Leaflet plugins -->
    <script src="lib/measure/Leaflet.draw.js"></script>
    <script src="lib/measure/Leaflet.Draw.Event.js"></script>
    <script src="lib/measure/Toolbar.js"></script>
    <script src="lib/measure/Tooltip.js"></script>
    <script src="lib/measure/GeometryUtil.js"></script>
    <script src="lib/measure/LatLngUtil.js"></script>
    <script src="lib/measure/TouchEvents.js"></script>
    <script src="lib/measure/DrawToolbar.js"></script>
    <script src="lib/measure/Draw.Feature.js"></script>
    <script src="lib/measure/Draw.SimpleShape.js"></script>
    <script src="lib/measure/Draw.Polyline.js"></script>
    <script src="lib/measure/Control.Draw.js"></script>
    <script src="lib/measure/leaflet.measurecontrol.js"></script>
    <script src="lib/Control.Coordinates.js"></script>
    <!-- Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.8/dist/esri-leaflet.js"
        integrity="sha512-E0DKVahIg0p1UHR2Kf9NX7x7TUewJb30mxkxEm2qOYTVJObgsAGpEol9F6iK6oefCbkJiA4/i6fnTHzM6H1kEA=="
        crossorigin=""></script>
    <!-- Esri Leaflet Vector from CDN -->
    <script src="https://unpkg.com/esri-leaflet-vector@3.1.2/dist/esri-leaflet-vector.js"
        integrity="sha512-SnA/TobYvMdLwGPv48bsO+9ROk7kqKu/tI9TelKQsDe+KZL0TUUWml56TZIMGcpHcVctpaU6Mz4bvboUQDuU3w=="
        crossorigin=""></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css" rel="stylesheet">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-172813797-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-172813797-1');
    </script>
    <!-- estilos -->
    <link rel="stylesheet" href="lib/measure/leaflet.draw.css" />
    <link rel="stylesheet" href="lib/Control.Coordinates.css" />
    <link rel="stylesheet" href="plantacadastral.css" />
</head>

<body>
    <div id='pagina'>
        <div id='conteiner0a'>
            <button id="hamburger">&#9776;</button>
            <div id='logo'>
                <img src="images/favicon-32x32.png" style="height:auto; width:auto; padding:3px;">
                <span>Município de Itajaí </br> <b>PLANTA CADASTRAL</b></span>
            </div>
            <div id='util'>
                <form>
                    <input id="pesquisaRapida" placeholder="Pesquisa inscr.imobiliária, código ou logradouro"
                        style="border: none; width: 300px; background-color: white;">
                </form>
            </div>
        </div>
        <div id='conteiner0b'>
            <div id='barraLateral'>
                <h3>Início</h3>
                <div>
                    <center>
                        <p>Secretaria Municipal da Fazenda</p>
                        <p><small>Cadastro Técnico Municipal</small></p>
                        <hr>
                        <p><small>Clique sobre um lote ou via para visualizar as propriedades.</small></p>
                        <a href="https://geoitajai.github.io/geo/arquivos.html" target="_blank">
                            <font size="1" color="black">
                                DOWNLOADS(pdf, dwg, shp)
                            </font>
                    </center>
                    </a>
                </div>
                <h3> Grau de Risco Atividades</h3>
                <div>
                    <p>
                        <center><small>Anexo lei Nº 11.985, DE 24 DE AGOSTO DE 2020:</small></center>
                    </p>
                    <a href="https://geoitajai.github.io/geo/tabela_risco.html" target="_blank">
                        <center>
                            <font size="2">
                                - LINK CONSULTA<br>TABELA DE GRAU DE RISCO / CÓDIGO CNAE
                            </font>
                        </center>
                    </a>
                    <br>
                    <a style="text-decoration:none" href="http://leismunicipa.is/hyrip" target="_blank">
                        <center>
                            <font size="1">
                                Decreto Nº 11.985, 24 de Agosto de 2020.
                            </font>
                        </center>
                    </a>
                    <br>
                    <a style="text-decoration:none" href="http://leismunicipa.is/pqbya" target="_blank">
                        <center>
                            <font size="1">
                                Decreto Nº 11.956, 24 de Agosto de 2020.
                            </font>
                        </center>
                    </a>
                    <br>
                </div>
                <!-- <h3>Section 3</h3>
                <div>
                    <p>
                        Nam enim risus, molestie et, porta ac, aliquam ac, risus. Quisque lobortis.
                        Phasellus pellentesque purus in massa. Aenean in pede. Phasellus ac libero
                    </p>
                    <ul>
                        <li>List item one</li>
                        <li>List item two</li>
                        <li>List item three</li>
                    </ul>
                </div>
                <h3>Section 4</h3>
                <div>
                    <p>
                        Cras dictum. Pellentesque habitant morbi tristique senectus et netus
                        et malesuada fames ac turpis egestas. Vestibulum ante ipsum primis in
                    </p>
                    <p>
                        Suspendisse eu nisl. Nullam ut libero. Integer dignissim consequat lectus.
                    </p>
                </div> -->
            </div>
            <div id="mapa">mapa</div>
        </div>
        <div id="areatab">
            <div id='txt_tabela'>
                Planta cadastral para simples conferência dos dados de cada imóvel, sujeita a alterações sem aviso
                prévio. NÃO CONSTITUI DIREITO DE PROPRIEDADE.
            </div>
            <div id="tabelatabulator"></div>
        </div>

    </div>

    <script>
        $(function () {
            $('#barraLateral').accordion({
                heightStyle: 'content',
                activate: function (event, ui) { }
            });
        });

        $('#hamburger').click(function () {
            $('#barraLateral').toggle();
            mapa.invalidateSize();
        });

        //#div do mapa
        let mapa = new L.Map('mapa', {
            zoom: 14,
            minZoom: 12,
            maxZoom: 19,
            maxBounds: [
                //south west
                [-27.3000, -49.2300],
                //north east
                [-26.3285, -48.3200]
            ],
            center: new L.latLng([-26.9046, -48.6874]),
            zoomControl: false,
            preferCanvas: true
        });

        mapa.createPane('basemap_numeracao');
        mapa.getPane('basemap_numeracao').style.zIndex = 401;
        mapa.getPane('basemap_numeracao').style.pointerEvents = 'none';
        mapa.createPane('basemap_overlay');
        mapa.getPane('basemap_overlay').style.zIndex = 402;

        //coordenadas no click
        const coordmapa = new L.Control.Coordinates({ promptText: 'Coordenadas para a área de transferência, utilize Ctrl+C', position: 'bottomright' }).addTo(mapa);

        //interatividade com mapa
        let zoomresultado = false;
        mapa.on('click', function (e) {
            coordmapa.setCoordinates(e);
            malhacadastral
                .identify()
                .layers("gisdb.itajai.viewcadastrolotesfazenda3857:0") // just the counties sublayer
                .on(mapa)
                .at(e.latlng)
                .run(function (error, featureCollection) {
                    if (error) {
                        return;
                    }
                    if (featureCollection.features.length == 1) {
                        zoomresultado = false;
                        pCestiloDestaque(featureCollection);
                    }
                });
        });

        //#basemaps
        //Mapa base, Urbanismo
        let tilesmu = L.esri.Vector.vectorTileLayer("7a110ef9198540068341e6908c6bf298", {
            portalUrl: "https://arcgis.itajai.sc.gov.br/portal",
            attribution: 'Prefeitura de Itajaí'
        }).addTo(mapa);

        //Mapa ortoimagem 2020
        let ortoimg2020 = L.esri.tiledMapLayer({
            url: "https://arcgis.itajai.sc.gov.br/server/rest/services/Hosted/Ortoimagem_restitui%C3%A7%C3%A3o_2020/MapServer",
            maxZoom: 19,
            maxNativeZoom: 18,
            attribution: 'Engemap geoinformação 2020, Prefeitura de Itajaí'
        });

        //Mapa base, ESRI
        let tileesri = new L.TileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            minZoom: 12,
            maxZoom: 19,
            opacity: 0.6,
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        //Controle de camadas
        let baseMaps = {
            "SIE.Itajaí": tilesmu,
            "Ortoimg": ortoimg2020,
            "Satélite": tileesri
        };

        L.control.layers(baseMaps, null, {
            collapsed: false,
            position: 'bottomright'
        }).addTo(mapa);

        //barra escala
        L.control.scale({
            position: "bottomright",
            imperial: false
        }).addTo(mapa);

        //Norte
        let nortemapa = L.control({
            position: 'bottomright'
        });
        nortemapa.onAdd = function (map) {
            let div = L.DomUtil.create('div', 'info2 legend');
            div.innerHTML +=
                '<center><sub><font size="4">▲</font></sub><br/>' +
                '<sup><font size="2">N</font></sup></center>'
            return div;
        };
        nortemapa.addTo(mapa);

        //Botão zoom posicionado
        L.control.zoom({
            position: 'topright'
        }).addTo(mapa);

        //Medidas
        L.Control.measureControl({
            position: 'topright'
        }).addTo(mapa);

        //#Cadastro
        //Definir elementos da tabela
        let table = new Tabulator('#tabelatabulator', {
            height: '100%',
            layout: 'fitColumns',
            columns: [
                {
                    title: 'Consulta Prévia (construções)',
                    formatter: 'link',
                    width: 210,
                    formatterParams: {
                        labelField: 'linkinfo',
                        urlField: 'consultaprevia',
                        target: '_blank'
                    }
                },
                {
                    title: 'Avaliação atividade (alvará)',
                    formatter: 'link',
                    width: 200,
                    formatterParams: {
                        labelField: 'linkinfo',
                        urlField: 'consultaalvara',
                        target: '_blank'
                    }
                },
                {
                    title: 'Cód.',
                    field: 'ncodimov',
                    width: 80
                }, {
                    title: 'Inscrição imob.',
                    field: 'ninscrao',
                    width: 150
                }, {
                    title: 'nº matrícula',
                    field: 'nmatricu',
                    width: 103
                }, {
                    title: 'Razão social',
                    field: 'nrazaoso',
                    width: 200
                }, {
                    title: 'Logradouro',
                    field: 'nlogrado',
                    width: 150
                }, {
                    title: 'nº',
                    field: 'nnumimov',
                    width: 60
                }, {
                    title: 'Compl.',
                    field: 'ncomplem',
                    width: 120
                }, {
                    title: 'Bairro',
                    field: 'nnomebai',
                    width: 100
                }, {
                    title: 'Área tributável',
                    field: 'nareater',
                    width: 110
                }, {
                    title: 'Ano construção',
                    field: 'ncodcont',
                    width: 110
                }, {
                    title: 'Fração ideal informada',
                    field: 'nfracaoi',
                    width: 90
                }
            ]
        });

        //camada lote destacado, permanece visível em todos os níveis
        let plantaCadastralDestaque = L.featureGroup().addTo(mapa);

        //estilo destacado, lote
        let cadastroimoveispts = L.esri.query({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/cadastroimoveispts/FeatureServer/0/'
        });

        let cadastroimoveisptscodimov = L.esri.query({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/cadastroimoveispts/FeatureServer/0/'
        });

        function pCestiloDestaque(e) {
            plantaCadastralDestaque.clearLayers();
            table.setData([]);
            let inscricaoimob = e.features[0].properties.inscricao;
            let zoneamento = e.features[0].properties.zon2012;
            L.geoJson(e, {
                style: {
                    weight: 5,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.7
                }
            }).addTo(plantaCadastralDestaque);
            if (zoomresultado == true) {
                mapa.flyToBounds(plantaCadastralDestaque.getBounds(), {
                    maxZoom: 19
                });
            };
            //dados tabela
            let inscricaowhereimovel = `lote_inscricao='${inscricaoimob}'`;
            let objtabela = [];
            let consultapreviap;
            let linkinfo;
            cadastroimoveispts.where(inscricaowhereimovel).returnGeometry(false);
            cadastroimoveispts.run((error, fcol) => {
                fcol.features.forEach(el => {
                    if (zoneamento == 'pend') {
                        linkinfo = 'consultar secretatira urbanismo';
                        consultapreviap = `https://geoitajai.github.io/geo/consultazoneamentoerro.html#${el.properties.lote_inscricao}`;
                        consultaalvara = `https://geoitajai.github.io/geo/consultaalvara.html#${el.properties.lote_inscricao}`;
                    } else {
                        linkinfo = 'clique para abrir';
                        consultapreviap = `https://geoitajai.github.io/geo/consultazoneamento.html#${el.properties.lote_inscricao}`;
                        consultaalvara = `https://geoitajai.github.io/geo/consultaalvara.html#${el.properties.lote_inscricao}`;
                    };
                    objtabela.push({
                        'consultaprevia': consultapreviap,
                        'ninscrao': el.properties.aut_inscricao,
                        'ncodimov': el.properties.aut_codigo_imovel,
                        'nmatricu': el.properties.aut_numero_matricula,
                        'nrazaoso': el.properties.nome_contribuinte,
                        'nlogrado': el.properties.aut_end_logradouro,
                        'nnumimov': el.properties.aut_end_numero,
                        'ncomplem': el.properties.aut_end_complemento,
                        'nnomebai': el.properties.aut_end_bairro,
                        'nareater': el.properties.aut_area_tributavel_terreno,
                        'ncodcont': el.properties.aut_ano_construcao,
                        'nfracaoi': el.properties.aut_fracao_informada,
                        'linkinfo': linkinfo,
                        'consultaalvara': consultaalvara
                    });
                });
                table.setData(objtabela);
            });
        };

        //tratar o resultado da pesquisa por código ou nº inscrição imobiliária
        let gsResultadoP = (result) => {
            plantaCadastralDestaque.clearLayers();
        };

        //Zoom e destaque para via a partir de geoJSON
        function destaquevia(g) {
            pesquisaQvias.clearLayers();
            viasgeom.query()
                .where(`nome = '${g}'`)
                .run((error, viaspesquisageom) => {
                    L.geoJson(viaspesquisageom, {
                        style: (feature) => {
                            return {
                                weight: 5,
                                color: "#ffff00",
                                dashArray: "30 10",
                                opacity: 0.6,
                                interactive: false
                            };
                        }
                    }).addTo(pesquisaQvias);
                    mapa.flyToBounds(pesquisaQvias.getBounds(), {
                        maxZoom: 19
                    });
                });
        };

        //Barra de pesquisa
        //tabela substituições
        let accentMap = {
            'á': 'a',
            'à': 'a',
            'ã': 'a',
            'â': 'a',
            'ç': 'c',
            'é': 'e',
            'è': 'e',
            'í': 'i',
            'ì': 'i',
            'ó': 'o',
            'ò': 'o',
            'õ': 'o',
            'ô': 'o',
            'ú': 'u',
            'ù': 'u'
        };

        //substituição de caracteres especiais
        let normalize = (term) => {
            let ret = "";
            for (let i = 0; i < term.length; i++) {
                ret += accentMap[term.charAt(i)] || term.charAt(i);
            }
            return ret;
        };

        //função de pesquisa
        let pesquisaQvias = L.featureGroup().addTo(mapa);
        let listaViasAutoComplete = [];

        let viaspesquisa = L.esri.query({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/sistema_viario/FeatureServer/0/'
        });

        viaspesquisa.fields(['nome'])
            .returnGeometry(false)
            .distinct()
            .run(function (error, psqvias) {
                psqvias.features.forEach((e) => {
                    listaViasAutoComplete.push(e.properties.nome)
                });

                $(() => {
                    $("#pesquisaRapida").autocomplete({
                        minLength: 3,
                        autoFocus: true,
                        source: (request, response) => {
                            let matcher = new RegExp($.ui.autocomplete.escapeRegex(request
                                .term), "i");
                            response($.grep(listaViasAutoComplete, (value) => {
                                value = value.label || value.value || value;
                                return matcher.test(value) || matcher.test(
                                    normalize(value));
                            }));
                        },
                        select: (event, ui) => {
                            destaquevia(ui.item.value);
                        },
                        close: (e) => {
                            e.target.value = '';
                        }
                    }).keypress((event) => {
                        if (event.keyCode == 13) {
                            event.preventDefault();
                            if ($("#pesquisaRapida").val().length === 15) {
                                malhacadastralpesquisa.query()
                                    .where(`inscricao = '${$("#pesquisaRapida").val()}'`)
                                    .run((error, fcolinscr) => {
                                        if (fcolinscr.features.length == 0) {
                                            alert("Não encontrado");
                                        } else {
                                            zoomresultado = true;
                                            pCestiloDestaque(fcolinscr);
                                        };
                                    });
                            } else {
                                cadastroimoveisptscodimov.where(`aut_codigo_imovel='${$("#pesquisaRapida").val()}'`)
                                    .returnGeometry(false)
                                    .limit(1)
                                    .fields(['lote_inscricao']).run(function (error, fcolcod) {
                                        if (fcolcod.features.length == 0) {
                                            alert("Não encontrado");
                                        } else {
                                            malhacadastralpesquisa.query()
                                                .where(`inscricao = '${fcolcod.features[0].properties.lote_inscricao}'`)
                                                .run((error, fcolcodinscr) => {
                                                    zoomresultado = true;
                                                    pCestiloDestaque(fcolcodinscr)
                                                });
                                        };
                                    });
                            };
                            $("#pesquisaRapida").val("");
                        }
                    });
                });
            });

        // Feature layer e imagem, malha cadastral
        let malhacadastral = new L.esri.dynamicMapLayer({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/malha_cadastral_raster/MapServer/',
            pane: 'basemap_numeracao',
            minZoom: 15,
            maxZoom: 19,
            opacity: 0.9
        }).addTo(mapa);

        let malhacadastralpesquisa = new L.esri.featureLayer({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/malha_cadastral_raster/FeatureServer/0/'
        });

        //sistema viário
        //popup
        let viaspop = L.esri.query({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/sistema_viario/FeatureServer/0/'
        });
        function pCestiloDestaqVia(e) {
            pesquisaQvias.clearLayers();
            viaspop.where(`codsecao ='${e.target.feature.properties.codsecao}'`)
                .returnGeometry(false)
                .limit(1)
                .run(function (error, fcvias) {
                    let via = fcvias.features[0].properties;
                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(
                            '<strong>' + via.nome + '</strong></br>' +
                            'Lei/data: ' + via.leidata + '</br>' +
                            'Cx.da via: ' + via.largura + 'm' + ' - Passeios:' + via.passeiod + '/' + via.passeioe + 'm' + '</br>' +
                            'Código: ' + via.cod
                        )
                        .openOn(mapa);
                });
            L.geoJson(e.sourceTarget.feature, {
                style: (feature) => {
                    return {
                        weight: 5,
                        color: "#ffff00",
                        dashArray: "30 10",
                        opacity: 0.6,
                        interactive: false
                    };
                }
            }).addTo(pesquisaQvias);
            if (zoomresultado == true) {
                mapa.flyToBounds(plantaCadastralDestaque.getBounds(), {
                    maxZoom: 19
                });
            };
            zoomresultado = false;
        };

        //camada via
        function inteVia(feature, layer) {
            layer.on({
                click: pCestiloDestaqVia
            });
        };
        let viasgeom = L.esri.featureLayer({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/sistema_viario/FeatureServer/0/',
            fields: ['nome', 'codsecao', 'objectid'],
            minZoom: 17,
            precision: 6,
            style: (feature) => {
                return {
                    color: '#ffffff00',
                    weight: 15
                };
            },
            onEachFeature: inteVia,
        }).addTo(mapa);

        //#camadas, barra lateral
        let detpropostas;
        let plantaZoneamento;

        //localização
        function onLocationFound(e) {
            let radius = e.accuracy / 2;
        };
        mapa.on('locationfound', onLocationFound);
        function onLocationError(e) {
            alert(e.message);
        };
        mapa.on('locationerror', onLocationError);

        //botão localização
        let customControl = L.Control.extend({
            options: {
                position: 'topright'
            },
            onAdd: function (mapa) {
                let container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                L.DomEvent.disableClickPropagation(container);
                container.style.backgroundColor = 'white';
                container.style.backgroundImage = "url(images/flatmap64x64.png)";
                container.style.backgroundSize = "26px 26px";
                container.style.width = '26px';
                container.style.height = '26px';
                container.onclick = function () {
                    mapa.locate({
                        setView: true,
                        setZoom: 17
                    });
                }
                return container;
            }
        });
        mapa.addControl(new customControl());

        //Limites Município
        $.getJSON("data/limintermunicipais.geojson", function (data) {
            L.geoJson(data, {
                style: (feature) => {
                    return {
                        color: '#000000',
                        opacity: 0.5,
                        fill: false,
                        interactive: false
                    };
                }
            }).addTo(mapa);
        });
    </script>
</body>

</html>