<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <title>Planta Cadastral</title>
    <link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <!-- jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <!-- jQuery UI -->
    <link href="lib/jquery-ui.min.css" rel="stylesheet">
    <link href="lib/jquery-ui.theme.min.css" rel="stylesheet">
    <script src="lib/jquery-ui.min.js"></script>
    <!-- Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha384-VzLXTJGPSyTLX6d96AxgkKvE/LRb7ECGyTxuwtpjHnVWVZs2gp5RDjeM/tgBnVdM" crossorigin="anonymous" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha384-RFZC58YeKApoNsIbBxf4z6JJXmh+geBSgkCQXFyh+4tiFSJmJBt+2FbjxW7Ar16M"
        crossorigin="anonymous"></script>
    <!-- Tabulator from CDN -->
    <link href="https://unpkg.com/tabulator-tables@5.2.4/dist/css/tabulator_simple.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.2.4/dist/js/tabulator.min.js"></script>
    <!-- Leaflet plugins -->
    <script src="lib/measure/Leaflet.draw.js"></script>
    <script src="lib/measure/Leaflet.Draw.Event.js"></script>
    <script src="lib/measure/Toolbar.js"></script>
    <script src="lib/measure/Tooltip.js"></script>
    <script src="lib/measure/GeometryUtil.js"></script>
    <script src="lib/measure/LatLngUtil.js"></script>
    <script src="lib/measure/TouchEvents.js"></script>
    <script src="lib/measure/DrawToolbar.js"></script>
    <script src="lib/measure/Draw.Feature.js"></script>
    <script src="lib/measure/Draw.SimpleShape.js"></script>
    <script src="lib/measure/Draw.Polyline.js"></script>
    <script src="lib/measure/Control.Draw.js"></script>
    <script src="lib/measure/leaflet.measurecontrol.js"></script>
    <script src="lib/Control.Coordinates.js"></script>
    <!-- Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.8/dist/esri-leaflet.js"
        integrity="sha512-E0DKVahIg0p1UHR2Kf9NX7x7TUewJb30mxkxEm2qOYTVJObgsAGpEol9F6iK6oefCbkJiA4/i6fnTHzM6H1kEA=="
        crossorigin=""></script>
    <!-- Esri Leaflet Vector from CDN -->
    <script src="https://unpkg.com/esri-leaflet-vector@3.1.2/dist/esri-leaflet-vector.js"
        integrity="sha512-SnA/TobYvMdLwGPv48bsO+9ROk7kqKu/tI9TelKQsDe+KZL0TUUWml56TZIMGcpHcVctpaU6Mz4bvboUQDuU3w=="
        crossorigin=""></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css" rel="stylesheet">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-172813797-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-172813797-1');
    </script>
    <!-- estilos -->
    <link rel="stylesheet" href="lib/measure/leaflet.draw.css" />
    <link rel="stylesheet" href="lib/Control.Coordinates.css" />
    <link rel="stylesheet" href="plantacadastral.css" />
</head>

<body>
    <div id='pagina'>
        <div id='conteiner0a'>
            <button id="hamburger">&#9776;</button>
            <div id='logo'>
                <img src="images/favicon-32x32.png" style="height:auto; width:auto; padding:3px;">
                <span>Município de Itajaí </br> <b>PLANTA CADASTRAL</b></span>
            </div>
            <div id='util'>
                <form>
                    <input id="pesquisaRapida" placeholder="pesquisa: endereço,nº - código - inscr.imobiliária"
                        type="text" spellcheck="false" style="border: none; width: 320px; background-color: white;">
                </form>
            </div>
        </div>
        <div id='conteiner0b'>
            <div id='barraLateral'>
                <h3 class='titulobarra'>Início</h3>
                <div class='conteudobarralateral'>
                    <center>
                        <p>Secretaria Municipal da Fazenda</p>
                        <p><small>Cadastro Técnico Municipal</small></p>
                        <p><small>Mais informações:</small>
                            <br>
                            <a href="https://geo.itajai.sc.gov.br/geoitajai/" target="_blank">
                                <font size="2" color="black">
                                    PORTAL GEOITAJAÍ
                                </font>
                        </p>
                        <p>
                            <a href="https://arcgis.itajai.sc.gov.br/geoitajai/plantacadastral/arquivos.html"
                                target="_blank">
                                <font size="2" color="black">
                                    Downloads
                                </font>
                        </p>
                    </center>
                    </a>
                </div>
                <h3 class='titulobarra'> Grau de Risco Atividades</h3>
                <div class='conteudobarralateral'>
                    <p>
                        <center><small>Anexo lei Nº 11.985, DE 24 DE AGOSTO DE 2020:</small></center>
                    </p>
                    <a href="https://arcgis.itajai.sc.gov.br/geoitajai/plantacadastral/tabela_risco.html"
                        target="_blank">
                        <center>
                            <font size="2">
                                - LINK CONSULTA<br>TABELA DE GRAU DE RISCO / CÓDIGO CNAE
                            </font>
                        </center>
                    </a>
                    <p><a style="text-decoration:none" href="http://leismunicipa.is/hyrip" target="_blank">
                            <center>
                                <font size="1">
                                    Decreto Nº 11.985, 24 de Agosto de 2020.
                                </font>
                            </center>
                        </a>
                        <a style="text-decoration:none" href="http://leismunicipa.is/pqbya" target="_blank">
                            <center>
                                <font size="1">
                                    Decreto Nº 11.956, 24 de Agosto de 2020.
                                </font>
                            </center>
                        </a>
                    </p>
                </div>
                <h3 class='titulobarra'>Zoneamento</h3>
                <div class='conteudobarralateral'>
                    <p>
                        <a href="http://leismunicipa.is/pfdkq" target="_blank">
                            <font size="2" color="black">
                                Lei complementar nº215, 31-12-2012
                            </font>
                        </a>
                    </p>
                    <p>Legenda:</p>
                    <p>
                        <span style="color:red">█</span>CCS1</br>
                        <span style="color:#723900">█</span>CCS2</br>
                        <span style="color:#b82e00">█</span>CCS3</br>
                    </p>
                    <hr>
                    <p><small>Clique em uma zona no mapa para visualizar os parâmetros.</small></p>
                </div>
                <h3 class='titulobarra'>Engenharia de Trânsito</h3>
                <div>
                    <p>
                        <center>
                            <font size="2">
                                <strong>
                                    SMU-DET
                                </strong>
                                <br />
                                Propostas de intervenções viárias.
                            </font>
                        </center>
                    </p>
                    <p>Legenda:</p>
                    <img src="images/legDET.svg" style="width:140px;">
                    <hr>
                    <p><small>Estudo conceitual.</small></p>
                </div>
                <h3 class='titulobarra'>Parcelamento do solo</h3>
                <div>
                    <center>
                        <p>
                            <font size="2">
                                <strong>
                                    Acervo parcial de pranchas digitalizadas.
                                </strong>
                            </font>
                        </p>
                        <p><small>Secretaria Municipal de Desenvolvimento Urbano e Habitação</small></p>
                    </center>
                </div>
            </div>
            <div id="mapa">mapa</div>
        </div>
        <div id="areatab">
            <div id='txt_tabela'>
                <center>
                    Planta cadastral para simples conferência dos dados de cada imóvel, sujeita a alterações sem aviso
                    prévio. NÃO CONSTITUI DIREITO DE PROPRIEDADE.
                </center>
            </div>
            <div id="tabelatabulator"></div>
        </div>

    </div>

    <script>
        $(function () {
            $('#barraLateral').accordion({
                heightStyle: 'content'
            });
        });

        $('#hamburger').click(() => {
            $('#barraLateral').toggle();
            mapa.invalidateSize();
        });

        //#div do mapa
        let mapa = new L.Map('mapa', {
            zoom: 14,
            minZoom: 12,
            maxZoom: 19,
            maxBounds: [
                //south west
                [-27.3000, -49.2300],
                //north east
                [-26.3285, -48.3200]
            ],
            center: new L.latLng([-26.9046, -48.6874]),
            zoomControl: false,
            preferCanvas: true
        });

        mapa.createPane('basemap_numeracao');
        mapa.getPane('basemap_numeracao').style.zIndex = 401;
        mapa.getPane('basemap_numeracao').style.pointerEvents = 'none';
        mapa.createPane('basemap_overlay');
        mapa.getPane('basemap_overlay').style.zIndex = 601;
        mapa.createPane('marker_overlay');
        mapa.getPane('marker_overlay').style.zIndex = 602;

        //coordenadas no click
        const coordmapa = new L.Control.Coordinates({ promptText: 'Coordenadas para a área de transferência, utilize Ctrl+C', position: 'bottomright' }).addTo(mapa);

        //interatividade com mapa
        let loteresultado = true;
        zoomresultado = false;
        mapa.on('click', (e) => {
            coordmapa.setCoordinates(e);
            if (loteresultado == true && mapa.getZoom() >= 15) {
                malhacadastral
                    .identify()
                    .layers("gisdb.itajai.viewcadastrolotesfazenda3857:0")
                    .on(mapa)
                    .at(e.latlng)
                    .run((error, featureCollection) => {
                        if (error) {
                            return;
                        }
                        if (featureCollection.features.length == 1) {
                            zoomresultado = false;
                            pCestiloDestaque(featureCollection);
                        }
                    });
            };
        });

        //#basemaps
        //Mapa base, Urbanismo
        let tilesmu = L.esri.Vector.vectorTileLayer("7a110ef9198540068341e6908c6bf298", {
            portalUrl: "https://arcgis.itajai.sc.gov.br/portal",
            attribution: 'Prefeitura de Itajaí'
        }).addTo(mapa);

        //Mapa ortoimagem 2020
        let ortoimg2020 = L.esri.tiledMapLayer({
            url: "https://arcgis.itajai.sc.gov.br/server/rest/services/Hosted/Ortoimagem_restitui%C3%A7%C3%A3o_2020/MapServer",
            maxZoom: 19,
            maxNativeZoom: 18,
            attribution: 'Engemap geoinformação 2020, Prefeitura de Itajaí'
        });

        //Mapa base, ESRI
        let tileesri = new L.TileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            minZoom: 12,
            maxZoom: 19,
            opacity: 0.6,
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        //Controle de camadas
        let baseMaps = {
            "SIE.Itajaí": tilesmu,
            "Ortoimg": ortoimg2020,
            "Satélite": tileesri
        };

        L.control.layers(baseMaps, null, {
            collapsed: false,
            position: 'bottomright'
        }).addTo(mapa);

        //barra escala
        L.control.scale({
            position: "bottomright",
            imperial: false
        }).addTo(mapa);

        //Norte
        let nortemapa = L.control({
            position: 'bottomright'
        });
        nortemapa.onAdd = (map) => {
            let div = L.DomUtil.create('div', 'info2 legend');
            div.innerHTML +=
                '<center><sub><font size="4">▲</font></sub><br/>' +
                '<sup><font size="2">N</font></sup></center>'
            return div;
        };
        nortemapa.addTo(mapa);

        //Botão zoom posicionado
        L.control.zoom({
            position: 'topright'
        }).addTo(mapa);

        //Medidas
        L.Control.measureControl({
            position: 'topright'
        }).addTo(mapa);

        //#Cadastro
        //camada lote destacado, permanece visível em todos os níveis
        let plantaCadastralDestaque = L.featureGroup({ pane: 'basemap_overlay' }).addTo(mapa);

        //dados, imóveis
        let cadastroimoveispts = L.esri.query({
            //url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/cadastroimoveispts/FeatureServer/0/'
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/Hosted/tmi_imoveis/FeatureServer/0/'
        });
        let cadastroimoveisptscodimov = L.esri.query({
            //url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/cadastroimoveispts/FeatureServer/0/'
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/Hosted/tmi_imoveis/FeatureServer/0/'
        });

        //Definir elementos da tabela
        let colunaspadrao = [
            {
                title: 'Consulta<br>Prévia<br>(construções)',
                formatter: 'link',
                width: 114,
                formatterParams: {
                    labelField: 'linkinfo',
                    urlField: 'consultaprevia',
                    target: '_blank'
                }
            }, {
                title: 'Avaliação<br>atividade<br>(alvará)',
                formatter: 'link',
                width: 100,
                formatterParams: {
                    labelField: 'linkinfo',
                    urlField: 'consultaalvara',
                    target: '_blank'
                }
            }, {
                title: 'Cód.<br>(clique<br>para copiar)',
                field: 'ncodimov',
                width: 110,
                cellClick: function (e, cell) {
                    navigator.clipboard.writeText(`http://plantacadastral.itajai.sc.gov.br#|${cell._cell.value}`);
                }
            }, {
                title: 'Inscrição imob.<br>(clique para copiar)',
                field: 'ninscrao',
                width: 153,
                cellClick: function (e, cell) {
                    navigator.clipboard.writeText(cell._cell.value);
                }
            }, {
                title: 'Razão social',
                field: 'nrazaoso',
                width: 200
            }, {
                title: 'nº matrícula',
                field: 'nmatricu',
                width: 103
            }, {
                title: 'Logradouro',
                field: 'nlogrado',
                width: 150
            }, {
                title: 'nº',
                field: 'nnumimov',
                width: 60
            }, {
                title: 'Compl.',
                field: 'ncomplem',
                width: 120
            }, {
                title: 'Bairro',
                field: 'nnomebai',
                width: 100
            }, {
                title: 'Área tributável',
                field: 'nareater',
                width: 110
            }, {
                title: 'Ano construção',
                field: 'ncodcont',
                width: 110
            }, {
                title: 'Fração ideal informada',
                field: 'nfracaoi',
                width: 90
            }
        ];
        let table = new Tabulator('#tabelatabulator', {
            height: '100%',
            layout: 'fitColumns',
            selectable: 1,
            //clipboard: true,
            columns: colunaspadrao
        });
        function pCestiloDestaque(e) {
            plantaCadastralDestaque.clearLayers();
            table.setData([]);
            //dados tabela
            let inscricaoimob = `${e.features[0].properties.inscrlig}`;
            let inscricaowhereimovel = `inscrlig='${inscricaoimob}'`;
            let objtabela = [];
            cadastroimoveispts.where(inscricaowhereimovel)
                .returnGeometry(false)
                .run((error, fcol) => {
                    fcol.features.forEach(el => {
                        linkinfo = 'consultar';
                        consultapreviap = `https://arcgis.itajai.sc.gov.br/geoitajai/plantacadastral/consultazoneamento.html#${el.properties.inscrlig}`;
                        consultaalvara = `https://arcgis.itajai.sc.gov.br/geoitajai/plantacadastral/consultaalvara.html#${el.properties.inscrlig}`;
                        objtabela.push({
                            'consultaprevia': consultapreviap,
                            'ninscrao': el.properties.aut_inscricao,
                            'ncodimov': el.properties.aut_codigo_imovel,
                            'nrazaoso': el.properties.nome_contribuinte,
                            'nmatricu': el.properties.aut_numero_matricula,
                            'nlogrado': el.properties.aut_end_logradouro,
                            'nnumimov': el.properties.aut_end_numero,
                            'ncomplem': el.properties.aut_end_complemento,
                            'nnomebai': el.properties.aut_end_bairro,
                            'nareater': el.properties.aut_area_tributavel_terreno,
                            'ncodcont': el.properties.aut_ano_construcao,
                            'nfracaoi': el.properties.aut_fracao_informada,
                            'linkinfo': linkinfo,
                            'consultaalvara': consultaalvara
                        });
                    });
                    table.setData(objtabela);
                });
            //lote no mapa
            L.geoJson(e, {
                style: {
                    weight: 5,
                    color: '##333',
                    dashArray: '',
                    fillOpacity: 0.5
                }
            }).addTo(plantaCadastralDestaque);
            if (zoomresultado == true) {
                mapa.flyToBounds(plantaCadastralDestaque.getBounds(), {
                    maxZoom: 19
                });
            };
        };

        //Zoom e destaque para via a partir de geoJSON
        function destaquevia(g) {
            pesquisaQvias.clearLayers();
            viasgeom.query()
                .where(`nome = '${g}'`)
                .run((error, viaspesquisageom) => {
                    L.geoJson(viaspesquisageom, {
                        style: (feature) => {
                            return {
                                weight: 5,
                                color: "#ffff00",
                                dashArray: "30 10",
                                opacity: 0.6,
                                interactive: false
                            };
                        }
                    }).addTo(pesquisaQvias);
                    mapa.flyToBounds(pesquisaQvias.getBounds(), {
                        maxZoom: 19
                    });
                });
        };

        //Barra de pesquisa
        //tabela substituições
        let accentMap = {
            'á': 'a',
            'à': 'a',
            'ã': 'a',
            'â': 'a',
            'ç': 'c',
            'é': 'e',
            'è': 'e',
            'í': 'i',
            'ì': 'i',
            'ó': 'o',
            'ò': 'o',
            'õ': 'o',
            'ô': 'o',
            'ú': 'u',
            'ù': 'u'
        };

        //substituição de caracteres especiais
        let normalize = (term) => {
            let ret = "";
            for (let i = 0; i < term.length; i++) {
                ret += accentMap[term.charAt(i)] || term.charAt(i);
            }
            return ret;
        };

        //função de pesquisa
        let pesquisaQvias = L.featureGroup().addTo(mapa);
        let viaspesquisa = L.esri.query({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/sistema_viario/FeatureServer/0/'
        });

        //caixa de pesquisa
        let itensPesquisa = [];
        let itensPesquisaCompletos = {};
        viaspesquisa.fields(['nome'])
            .returnGeometry(false)
            .distinct()
            .run((error, psqvias) => {
                let itenspesquisa = psqvias.features.map((feicoes) => {
                    return feicoes.properties.nome
                }).sort();
                itensarquivo = itenspesquisa;
                $(() => {
                    let pesquisaval;
                    $('#pesquisaRapida').autocomplete({
                        delay: 200,
                        minLength: 3,
                        autoFocus: true,
                        source: (request, response) => {
                            let matcher = new RegExp($.ui.autocomplete.escapeRegex(request
                                .term), 'i');
                            response($.grep(itenspesquisa, (value) => {
                                value = value.label || value.value || value;
                                return matcher.test(value) || matcher.test(
                                    normalize(value));
                            }));
                        },
                        select: (event, ui) => {
                            if ($('#pesquisaRapida').val().includes(',') == true) {
                                malhacadastralpesquisa.query()
                                    .where(`inscricao = '${itensPesquisaCompletos[pesquisaval]}'`)
                                    .run((error, fcolinscr) => {
                                        if (fcolinscr.features.length == 0) {
                                            alert("Não encontrado");
                                        } else {
                                            zoomresultado = true;
                                            pCestiloDestaque(fcolinscr);
                                            $("#pesquisaRapida").val('');
                                            itenspesquisa = itensarquivo;
                                        };
                                    });
                            } else {
                                destaquevia(ui.item.value);
                            };
                        },
                        focus: (event, ui) => {
                            pesquisaval = ui.item.value;
                        },
                        response: (event, ui) => {
                            if ($('#pesquisaRapida').val().includes(',') == false) {
                                itenspesquisa = itensarquivo;
                            };
                        }
                    }).keypress((event, ui) => {
                        if (event.keyCode == 13) {
                            event.preventDefault();
                            if ($("#pesquisaRapida").val().length === 15) {
                                let inscrlig = `${$("#pesquisaRapida").val().substr(0, 3)}${$("#pesquisaRapida").val().substr(4, 3)}${$("#pesquisaRapida").val().substr(11, 4)}`
                                malhacadastralpesquisa.query()
                                    .where(`inscrlig = '${inscrlig}'`)
                                    .run((error, fcolinscr) => {
                                        if (fcolinscr.features.length == 0) {
                                            alert("Não encontrado");
                                        } else {
                                            zoomresultado = true;
                                            pCestiloDestaque(fcolinscr);
                                            $("#pesquisaRapida").val('');
                                        };
                                    });
                            } else {
                                cadastroimoveisptscodimov.where(`aut_codigo_imovel='${$("#pesquisaRapida").val()}'`)
                                    .returnGeometry(false)
                                    .limit(1)
                                    .fields(['inscrlig']).run((error, fcolcod) => {
                                        console.log(fcolcod)
                                        if (fcolcod == null) {
                                            alert("Não encontrado");
                                        } else if (fcolcod.features.length == 0) {
                                            alert("Não encontrado");
                                        } else {
                                            malhacadastralpesquisa.query()
                                                .where(`inscrlig = '${fcolcod.features[0].properties.inscrlig}'`)
                                                .run((error, fcolcodinscr) => {
                                                    zoomresultado = true;
                                                    pCestiloDestaque(fcolcodinscr)
                                                    $("#pesquisaRapida").val('');
                                                });
                                        };
                                    });
                            };
                        };
                        if (event.keyCode == 44 && $('#pesquisaRapida').val().includes(',') == false) {
                            event.preventDefault();
                            malhacadastralpesquisa.query()
                                .fields(['nomevia', 'numero', 'inscricao'])
                                .where(`nomevia ='${pesquisaval}'`)
                                .distinct()
                                .run((error, psqvias) => {
                                    psqvias.features.map(e => {
                                        if (e.properties.numero != null) {
                                            let enderecomont = `${pesquisaval},${e.properties.numero}`;
                                            itensPesquisaCompletos[enderecomont] = e.properties.inscricao;
                                            itensPesquisa.push(enderecomont);
                                        };
                                    });
                                    itenspesquisa = itensPesquisa;
                                });
                            $('#pesquisaRapida').val(`${pesquisaval},`);
                            $('#pesquisaRapida').autocomplete('search', `${pesquisaval},`);
                        };
                    });
                });
            });
        $("#pesquisaRapida").click(() => {
            $(this).select();
        });

        // Feature layer e imagem, malha cadastral
        let malhacadastral = L.esri.dynamicMapLayer({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/malha_cadastral_raster/MapServer/',
            pane: 'basemap_numeracao',
            minZoom: 15,
            maxZoom: 19,
            opacity: 0.55,
            f: 'image',
            format: 'png8'
        }).addTo(mapa);

        let malhacadastralpesquisa = new L.esri.featureLayer({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/malha_cadastral_raster/FeatureServer/0/'
        });

        //sistema viário
        //popup
        let viaspop = L.esri.query({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/sistema_viario/FeatureServer/0/'
        });
        function pCestiloDestaqVia(e) {
            pesquisaQvias.clearLayers();
            viaspop.where(`codsecao ='${e.target.feature.properties.codsecao}'`)
                .returnGeometry(false)
                .limit(1)
                .run(function (error, fcvias) {
                    let via = fcvias.features[0].properties;
                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(
                            '<strong>' + via.nome + '</strong></br>' +
                            'Lei/data: ' + via.leidata + '</br>' +
                            'Cx.da via: ' + via.largura + 'm' + ' - Passeios:' + via.passeiod + '/' + via.passeioe + 'm' + '</br>' +
                            'Código: ' + via.cod
                        ).openOn(mapa);
                });
            L.geoJson(e.sourceTarget.feature, {
                style: (feature) => {
                    return {
                        weight: 5,
                        color: "#ffff00",
                        dashArray: "30 10",
                        opacity: 0.6,
                        interactive: false
                    };
                }
            }).addTo(pesquisaQvias);
            if (zoomresultado == true) {
                mapa.flyToBounds(plantaCadastralDestaque.getBounds(), {
                    maxZoom: 19
                });
            };
            zoomresultado = false;
        };

        //camada via
        function inteVia(feature, layer) {
            layer.on({
                click: pCestiloDestaqVia
            });
        };
        let viasgeom = L.esri.featureLayer({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/sistema_viario/FeatureServer/0/',
            fields: ['nome', 'codsecao', 'cod', 'objectid'],
            minZoom: 17,
            precision: 6,
            pane: 'marker_overlay',
            style: (feature) => {
                return {
                    color: '#ffffff00',
                    weight: 15
                };
            },
            onEachFeature: inteVia
        }).addTo(mapa);

        //#camadas, barra lateral
        let detpropostas;
        let plantaZoneamento;
        let parcelamentodosolo;
        let tabelaparcelamento = [];

        //#controle de camadas
        let limparcamadas = () => {
            if (mapa.hasLayer(detpropostas)) mapa.removeLayer(detpropostas);
            if (mapa.hasLayer(plantaZoneamento)) mapa.removeLayer(plantaZoneamento);
            if (mapa.hasLayer(parcelamentodosolo)) mapa.removeLayer(parcelamentodosolo);
            loteresultado = true;
        };
        $("#barraLateral").on("accordionactivate", (event, ui) => {
            if (ui.oldHeader["0"].textContent === 'Parcelamento do solo') {
                table.setColumns(colunaspadrao);
                table.setData();
            };
            if (
                ui.newHeader["0"].textContent === 'Zoneamento'
            ) {
                limparcamadas();
                if (plantaZoneamento == undefined) {
                    $.getScript('data/zon2012.js', () => { });
                } else {
                    loteresultado = false;
                    mapa.addLayer(plantaZoneamento);
                }
            }
            else if (
                ui.newHeader["0"].textContent === 'Engenharia de Trânsito'
            ) {
                limparcamadas();
                if (detpropostas == undefined) {
                    $.getScript('data/detpropostas.js', () => { });
                } else {
                    mapa.addLayer(detpropostas);
                }
            }
            else if (
                ui.newHeader["0"].textContent === 'Parcelamento do solo'
            ) {
                limparcamadas();
                if (parcelamentodosolo == undefined) {
                    $.getScript('data/parcelamentodosolo.js', () => { });
                } else {
                    mapa.addLayer(parcelamentodosolo);
                    loteresultado = false;
                    table.setColumns(colunasparcelamento);
                    table.setData(tabelaparcelamento);
                }
            }
            else {
                limparcamadas();
            };
        });

        //localização
        function onLocationFound(e) {
            let radius = e.accuracy / 2;
        };
        mapa.on('locationfound', onLocationFound);
        function onLocationError(e) {
            alert(e.message);
        };
        mapa.on('locationerror', onLocationError);

        //botão localização
        let customControl = L.Control.extend({
            options: {
                position: 'topright'
            },
            onAdd: function (mapa) {
                let container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                L.DomEvent.disableClickPropagation(container);
                container.style.backgroundColor = 'white';
                container.style.backgroundImage = "url(images/flatmap64x64.png)";
                container.style.backgroundSize = "26px 26px";
                container.style.width = '26px';
                container.style.height = '26px';
                container.onclick = function () {
                    mapa.locate({
                        setView: true,
                        setZoom: 17
                    });
                }
                return container;
            }
        });
        mapa.addControl(new customControl());

        //Limites Município
        $.getJSON("data/limintermunicipais.geojson", (data) => {
            L.geoJson(data, {
                style: (feature) => {
                    return {
                        color: '#000000',
                        opacity: 0.5,
                        fill: false,
                        interactive: false
                    };
                }
            }).addTo(mapa);
        });

        /*
       hash barra de endereço
       template:
       ---------
       #|códigoCadastro|inscriçãoImobiliária|códigoVia|Lat,Lng
       0 = para próximo item
       exemplo:
       --------
       http://plantacadastral.itajai.sc.gov.br#|271
       http://plantacadastral.itajai.sc.gov.br#|0|211.060.01.0135
       http://plantacadastral.itajai.sc.gov.br#|0|0|675
       http://plantacadastral.itajai.sc.gov.br#|0|0|0|-26.905269,-48.678927
       */
        function hashendereco(dados) {
            //hash código cadastro
            if (dados[1] !== '0') {
                cadastroimoveisptscodimov.where(`aut_codigo_imovel='${dados[1]}'`)
                    .returnGeometry(false)
                    .limit(1)
                    .fields(['inscrlig']).run((error, codhash) => {
                        if (codhash.features.length == 0) {
                            alert("Não encontrado");
                        } else {
                            malhacadastralpesquisa.query()
                                .where(`inscrlig = '${codhash.features[0].properties.inscrlig}'`)
                                .run((error, codinscrhash) => {
                                    zoomresultado = true;
                                    pCestiloDestaque(codinscrhash);
                                });
                        };
                    });
            }
            //hash inscrição imobiliária
            else if (dados[2] !== '0') {
                let inscrlig = `i${dados[2].substr(0, 3)}${dados[2].substr(4, 3)}${dados[2].substr(11, 4)}`
                malhacadastralpesquisa.query()
                    .where(`inscrlig = '${inscrlig}'`)
                    .run((error, inscricaohash) => {
                        zoomresultado = true;
                        pCestiloDestaque(inscricaohash);
                    });
            }
            //hash via
            else if (dados[3] !== '0') {
                viasgeom.query()
                    .where(`cod = '${dados[3]}'`)
                    .run((error, viahash) => {
                        L.geoJson(viahash, {
                            style: (feature) => {
                                return {
                                    weight: 5,
                                    color: "#ffff00",
                                    dashArray: "30 10",
                                    opacity: 0.6,
                                    interactive: false
                                };
                            }
                        }).addTo(pesquisaQvias);
                        mapa.flyToBounds(pesquisaQvias.getBounds(), {
                            maxZoom: 19
                        });
                    });
            }
            //hash zoom Latitude,Longitude
            else if (dados[4] !== '0') {
                let latlng = L.latLng(dados[4].split(','));
                L.marker(latlng).addTo(mapa);
                mapa.flyTo(latlng, 19);
            };
        };
        if (window.location.hash.split('|').length > 1) {
            hashendereco(window.location.hash.split('|'));
        } else if (window.location.hash.split('%7C').length > 1) {
            hashendereco(window.location.hash.split('%7C'));
        };
    </script>
</body>

</html>