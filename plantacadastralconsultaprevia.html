<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <title>Itajaí - Consulta Prévia ao Zoneamento</title>
    <link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
        integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
        integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <link rel="stylesheet" href="old_libs/jquery-ui.min.css" />
    <link rel="stylesheet" href="old_libs/jquery-ui.theme.min.css" />
    <!-- jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" crossorigin="anonymous"></script>
    <script src="old_libs/jquery-ui.min.js"></script>
    <script src="old_libs/fallback.js"></script>
    <!-- Tabulator from CDN -->
    <link href="https://unpkg.com/tabulator-tables@5.2.4/dist/css/tabulator_simple.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.2.4/dist/js/tabulator.min.js"></script>
    <!-- Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.8/dist/esri-leaflet.js"
        integrity="sha512-E0DKVahIg0p1UHR2Kf9NX7x7TUewJb30mxkxEm2qOYTVJObgsAGpEol9F6iK6oefCbkJiA4/i6fnTHzM6H1kEA=="
        crossorigin=""></script>
    <!-- Load Esri Leaflet from CDN -->
    <script src="old_libs/esri-leaflet.js"></script>
    <!-- Load Esri Leaflet Vector from CDN -->
    <script src="old_libs/esri-leaflet-vector.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="plantacadastralconsultaprevia.css" />
</head>

<body>
    <div class='conteiner1'>
        <div class='conteiner0' id="brastitulo">
            <div class='logo'>
                <img src="images/favicon-32x32.png" style="height:auto; width:auto; padding:3px;">
                <span>Município de Itajaí </br> <b>Consulta Prévia ao Zoneamento</b></span>
            </div>
            <div class='pesquisa'>
                <form>
                    <input id="pesquisaRapida" placeholder="Pesquisa inscr.imobiliária, código ou endereço" type="text"
                        spellcheck="false" style="width: 280px;">
                </form>
            </div>
        </div>
        <div class="mapa" id='mapa'>
            <div class="barraLateral barraLateralColap" style="width:250px;" id="barraCamadas">
                <button class="barraLateralEsconder" onclick="barraFechar()">Fechar &times;</button>
                <div id="barralateral">
                    <div div class="barraLateralConteudo">
                        </br>
                        <h3><span style="text-decoration: underline;">Consulta Prévia ao Zoneamento</span></h3>
                        <div>
                            <div style="text-align: left;">
                                <ul>
                                    <li>Pode ser feita uma pesquisa pelo código do imóvel ou Inscrição Imobiliária, como
                                        consta no IPTU.
                                    </li>
                                    <li>Também é possível pesquisar por uma rua.
                                    </li>
                                    <li>Para navegar, aproxime a uma área no mapa, <b>clique sobre o lote para
                                            selecionar</b></li>
                                </ul>
                            </div>
                            <p>
                                <b>Selecione o lote no mapa e utilize o botão </b><button type="button"
                                    class="botaopadrao" id="abrirConsultaPreviaP">
                                    <strong>ABRIR CONSULTA PRÉVIA</strong><img src="images/meclick.png"
                                        alt="clique para abrir" height="20" width="15">
                                </button>
                            </p>
                            <hr>
                            <p>
                                Caso marcados os campos, o parecer deve ser solicitados junto a cada órgão
                                competente:
                            </p>
                            <div style="text-align: left;">
                                <ul style="list-style-type: square;">
                                    <li>
                                        <a href="https://servicos.decea.gov.br/aga/?i=faq" target="_blank"
                                            rel="noopener">COMAER Curitiba</a>
                                    </li>
                                    <li>
                                        <a href="https://www.sie.sc.gov.br/fxd/inicio.jsp" target="_blank"
                                            rel="noopener">DEINFRA</a>
                                    </li>
                                    <li>
                                        <a href="https://defesacivil.itajai.sc.gov.br/" target="_blank" rel="noopener">
                                            Defesa Civil de Itajaí</a>
                                    </li>
                                    <li>
                                        <a href="https://www.itajai.sc.gov.br/e/meio-ambiente" target="_blank"
                                            rel="noopener">Instituto Itajaí Sustentável</a>
                                    </li>
                                    <li>
                                        <a href="https://itajai.sc.gov.br/e/urbanismo-e-habitacao" target="_blank"
                                            rel="noopener">Dep.de Engenharia de Trânsito - Secr.Municipal de
                                            Desenv.Urbano e Hab.</a>
                                    </li>
                                </ul>
                            </div>
                            </br>
                            <a href="https://geoitajai.github.io/geo/plantacadastral.html" target="_blank">
                                <font size="2">
                                    Planta Cadastral Completa: http://plantacadastral.itajai.sc.gov.br
                                </font>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <button class="barraLateralEsconder" onclick="barraAbrir()">Abrir ajuda &#8801;</button>
        </div>
        <button type="button" class="botaopadrao" id="abrirConsultaPrevia">
            <b>ABRIR CONSULTA PRÉVIA</b><img src="images/meclick.png" alt="clique para abrir" height="25" width="20">
        </button>
        <div class="tabela" id="tabelatabulator"></div>
    </div>

    <script>

        //barra lateral
        function barraAbrir() {
            document.getElementById("barraCamadas").style.display = "inline-block";
        }
        function barraFechar() {
            document.getElementById("barraCamadas").style.display = "none";
        }

        //#div do mapa
        let mapa = new L.Map('mapa', {
            zoom: 14,
            minZoom: 12,
            maxZoom: 19,
            maxBounds: [
                //south west
                [-27.3000, -49.2300],
                //north east
                [-26.3285, -48.3200]
            ],
            center: new L.latLng([-26.9046, -48.6874]),
            zoomControl: false,
            preferCanvas: true
        });

        mapa.createPane('basemap_numeracao');
        mapa.getPane('basemap_numeracao').style.zIndex = 402;
        mapa.getPane('basemap_numeracao').style.pointerEvents = 'none';
        mapa.createPane('zoneamento');
        mapa.getPane('zoneamento').style.zIndex = 401;
        mapa.getPane('zoneamento').style.pointerEvents = 'none';

        //interatividade com mapa
        let zoomresultado = false;
        let loteresultado = true;
        mapa.on('click', function (e) {
            if (loteresultado == true && mapa.getZoom() >= 15) {
                malhacadastral
                    .identify()
                    .layers("gisdb.itajai.viewcadastrolotesfazenda3857:0") // just the counties sublayer
                    .on(mapa)
                    .at(e.latlng)
                    .run(function (error, featureCollection) {
                        if (error) {
                            return;
                        }
                        if (featureCollection.features.length == 1) {
                            zoomresultado = false;
                            pCestiloDestaque(featureCollection);
                        }
                    });
            };
        });

        let tilesmu = L.esri.Vector.vectorTileLayer("7a110ef9198540068341e6908c6bf298", {
            portalUrl: "https://arcgis.itajai.sc.gov.br/portal"
        }).addTo(mapa);

        //Mapa base, ESRI
        let tileesri = new L.TileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            minZoom: 12,
            maxZoom: 19,
            opacity: 0.4,
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        //Zoneamento com legendas
        let tilezonea = L.tileLayer.fallback('data/zoneamento/tiles/{z}/{x}/{y}.png', {
            minZoom: 12,
            maxZoom: 19,
            pane: 'zoneamento',
            opacity: 0.5
        }).addTo(mapa);

        //Controle de camadas
        var baseMaps = {
            "SIE.Itajaí": tilesmu,
            "Satélite": tileesri
        };
        L.control.layers(baseMaps, null, {
            collapsed: false,
            position: 'bottomright'
        }).addTo(mapa);

        //barra escala
        L.control.scale({
            position: "bottomright",
            imperial: false
        }).addTo(mapa);

        //Norte
        let nortemapa = L.control({
            position: 'bottomright'
        });
        nortemapa.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info2 legend');
            div.innerHTML +=
                '<center><sub><font size="4">▲</font></sub><br/>' +
                '<sup><font size="2">N</font></sup></center>'
            return div;
        };
        nortemapa.addTo(mapa);

        //Botão zoom posicionado
        L.control.zoom({
            position: 'topright'
        }).addTo(mapa);

        //#Cadastro
        //Definir elementos da tabela
        let table = new Tabulator("#tabelatabulator", {
            height: "100%",
            layout: "fitColumns",
            columns: [
                {
                    title: 'inscrlig',
                    field: 'inscrlig',
                    visible: false
                }, {
                    title: 'Cód.',
                    field: 'ncodimov',
                    width: 80
                }, {
                    title: 'Inscrição imob.',
                    field: 'ninscrao',
                    width: 150
                }, {
                    title: 'nº matrícula',
                    field: 'nmatricu',
                    width: 103
                }, {
                    title: 'Razão social',
                    field: 'nrazaoso',
                    width: 200
                }, {
                    title: 'Logradouro',
                    field: 'nlogrado',
                    width: 150
                }, {
                    title: 'nº',
                    field: 'nnumimov',
                    width: 60
                }, {
                    title: 'Compl.',
                    field: 'ncomplem',
                    width: 120
                }, {
                    title: 'Bairro',
                    field: 'nnomebai',
                    width: 100
                }, {
                    title: 'Área tributável',
                    field: 'nareater',
                    width: 110
                }, {
                    title: 'Ano construção',
                    field: 'ncodcont',
                    width: 110
                }, {
                    title: 'Fração ideal informada',
                    field: 'nfracaoi',
                    width: 90
                }
            ]
        });

        //camada lote destacado, permanece visível em todos os níveis
        let plantaCadastralDestaque = L.featureGroup().addTo(mapa);

        //estilo destacado, lote
        let cadastroimoveispts = L.esri.query({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/Hosted/imoveis_plantacadastral/FeatureServer/0/'
        });

        let cadastroimoveisptscodimov = L.esri.query({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/Hosted/imoveis_plantacadastral/FeatureServer/0/'
        });

        function pCestiloDestaque(e) {
            plantaCadastralDestaque.clearLayers();
            table.setData([]);
            //dados tabela
            let inscricaoimob = `${e.features[0].properties.inscrlig}`;
            let inscricaowhereimovel = `inscrlig='${inscricaoimob}'`;
            let objtabela = [];
            cadastroimoveispts.where(inscricaowhereimovel)
                .returnGeometry(false)
                .run((error, fcol) => {
                    fcol.features.forEach(el => {
                        objtabela.push({
                            'ninscrao': el.properties.lote_inscricao,
                            'inscrlig': el.properties.inscrlig,
                            'ncodimov': el.properties.aut_codigo_imovel,
                            'nrazaoso': el.properties.nome_contribuinte,
                            'nmatricu': el.properties.aut_numero_matricula,
                            'nlogrado': el.properties.aut_end_logradouro,
                            'nnumimov': el.properties.aut_end_numero,
                            'ncomplem': el.properties.aut_end_complemento,
                            'nnomebai': el.properties.aut_end_bairro,
                            'nareater': el.properties.aut_area_tributavel_terreno,
                            'ncodcont': el.properties.aut_ano_construcao,
                            'nfracaoi': el.properties.aut_fracao_informada
                        });
                    });
                    table.setData(objtabela);
                });
            //lote no mapa
            L.geoJson(e, {
                style: {
                    weight: 5,
                    color: '##333',
                    dashArray: '',
                    fillOpacity: 0.5
                }
            }).addTo(plantaCadastralDestaque);
            if (zoomresultado == true) {
                mapa.flyToBounds(plantaCadastralDestaque.getBounds(), {
                    maxZoom: 19
                });
            };
        };

        //tratar o resultado da pesquisa por código ou nº inscrição imobiliária
        let gsResultadoP = (result) => {
            plantaCadastralDestaque.clearLayers();
        };

        //Zoom e destaque para via a partir de geoJSON
        function destaquevia(g) {
            pesquisaQvias.clearLayers();
            viasgeom.query()
                .where(`nome = '${g}'`)
                .run((error, viaspesquisageom) => {
                    L.geoJson(viaspesquisageom, {
                        style: (feature) => {
                            return {
                                weight: 5,
                                color: "#ffff00",
                                dashArray: "30 10",
                                opacity: 0.6,
                                interactive: false
                            };
                        }
                    }).addTo(pesquisaQvias);
                    mapa.flyToBounds(pesquisaQvias.getBounds(), {
                        maxZoom: 19
                    });
                });
        };

        //Barra de pesquisa
        //tabela substituições
        let accentMap = {
            'á': 'a',
            'à': 'a',
            'ã': 'a',
            'â': 'a',
            'ç': 'c',
            'é': 'e',
            'è': 'e',
            'í': 'i',
            'ì': 'i',
            'ó': 'o',
            'ò': 'o',
            'õ': 'o',
            'ô': 'o',
            'ú': 'u',
            'ù': 'u'
        };

        //substituição de caracteres especiais
        let normalize = (term) => {
            let ret = "";
            for (let i = 0; i < term.length; i++) {
                ret += accentMap[term.charAt(i)] || term.charAt(i);
            }
            return ret;
        };

        //função de pesquisa
        let pesquisaQvias = L.featureGroup().addTo(mapa);
        let listaViasAutoComplete = [];

        let viaspesquisa = L.esri.query({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/sistema_viario/FeatureServer/0/'
        });

        //caixa de pesquisa
        let itensPesquisa = [];
        let itensPesquisaCompletos = {};
        viaspesquisa.fields(['nome'])
            .returnGeometry(false)
            .distinct()
            .run((error, psqvias) => {
                let itenspesquisa = psqvias.features.map((feicoes) => {
                    return feicoes.properties.nome
                }).sort();
                itensarquivo = itenspesquisa;
                $(() => {
                    let pesquisaval;
                    $('#pesquisaRapida').autocomplete({
                        delay: 200,
                        minLength: 3,
                        autoFocus: true,
                        source: (request, response) => {
                            let matcher = new RegExp($.ui.autocomplete.escapeRegex(request
                                .term), 'i');
                            response($.grep(itenspesquisa, (value) => {
                                value = value.label || value.value || value;
                                return matcher.test(value) || matcher.test(
                                    normalize(value));
                            }));
                        },
                        select: (event, ui) => {
                            if ($('#pesquisaRapida').val().includes(',') == true) {
                                malhacadastralpesquisa.query()
                                    .where(`inscricao = '${itensPesquisaCompletos[pesquisaval]}'`)
                                    .run((error, fcolinscr) => {
                                        if (fcolinscr.features.length == 0) {
                                            alert("Não encontrado");
                                        } else {
                                            zoomresultado = true;
                                            pCestiloDestaque(fcolinscr);
                                            $("#pesquisaRapida").val('');
                                            itenspesquisa = itensarquivo;
                                        };
                                    });
                            } else {
                                destaquevia(ui.item.value);
                            };
                        },
                        focus: (event, ui) => {
                            pesquisaval = ui.item.value;
                        },
                        response: (event, ui) => {
                            if ($('#pesquisaRapida').val().includes(',') == false) {
                                itenspesquisa = itensarquivo;
                            };
                        }
                    }).keypress((event, ui) => {
                        if (event.keyCode == 13) {
                            event.preventDefault();
                            if ($("#pesquisaRapida").val().length === 15) {
                                let inscrlig = `i${$("#pesquisaRapida").val().substr(0, 3)}${$("#pesquisaRapida").val().substr(4, 3)}${$("#pesquisaRapida").val().substr(11, 4)}`
                                malhacadastralpesquisa.query()
                                    .where(`inscrlig = '${inscrlig}'`)
                                    .run((error, fcolinscr) => {
                                        if (fcolinscr.features.length == 0) {
                                            alert("Não encontrado");
                                        } else {
                                            zoomresultado = true;
                                            pCestiloDestaque(fcolinscr);
                                            $("#pesquisaRapida").val('');
                                        };
                                    });
                            } else {
                                cadastroimoveisptscodimov.where(`aut_codigo_imovel='${$("#pesquisaRapida").val()}'`)
                                    .returnGeometry(false)
                                    .limit(1)
                                    .fields(['inscrlig']).run((error, fcolcod) => {
                                        console.log(fcolcod)
                                        if (fcolcod == null) {
                                            alert("Não encontrado");
                                        } else if (fcolcod.features.length == 0) {
                                            alert("Não encontrado");
                                        } else {
                                            malhacadastralpesquisa.query()
                                                .where(`inscrlig = '${fcolcod.features[0].properties.inscrlig}'`)
                                                .run((error, fcolcodinscr) => {
                                                    zoomresultado = true;
                                                    pCestiloDestaque(fcolcodinscr)
                                                    $("#pesquisaRapida").val('');
                                                });
                                        };
                                    });
                            };
                        };
                        if (event.keyCode == 44 && $('#pesquisaRapida').val().includes(',') == false) {
                            event.preventDefault();
                            malhacadastralpesquisa.query()
                                .fields(['nomevia', 'numero', 'inscricao'])
                                .where(`nomevia ='${pesquisaval}'`)
                                .distinct()
                                .run((error, psqvias) => {
                                    psqvias.features.map(e => {
                                        if (e.properties.numero != null) {
                                            let enderecomont = `${pesquisaval},${e.properties.numero}`;
                                            itensPesquisaCompletos[enderecomont] = e.properties.inscricao;
                                            itensPesquisa.push(enderecomont);
                                        };
                                    });
                                    itenspesquisa = itensPesquisa;
                                });
                            $('#pesquisaRapida').val(`${pesquisaval},`);
                            $('#pesquisaRapida').autocomplete('search', `${pesquisaval},`);
                        };
                    });
                });
            });
        $("#pesquisaRapida").click(() => {
            $(this).select();
        });

        // Feature layer e imagem, malha cadastral
        let malhacadastral = new L.esri.dynamicMapLayer({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/malha_cadastral_raster/MapServer/',
            pane: 'basemap_numeracao',
            minZoom: 15,
            maxZoom: 19,
            opacity: 0.45,
            f: 'image',
            format: 'png8'
        }).addTo(mapa);

        let malhacadastralpesquisa = new L.esri.featureLayer({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/malha_cadastral_raster/FeatureServer/0/'
        });

        //sistema viário
        //popup
        let viaspop = L.esri.query({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/sistema_viario/FeatureServer/0/'
        });
        function pCestiloDestaqVia(e) {
            pesquisaQvias.clearLayers();
            viaspop.where(`codsecao ='${e.target.feature.properties.codsecao}'`)
                .returnGeometry(false)
                .limit(1)
                .run(function (error, fcvias) {
                    let via = fcvias.features[0].properties;
                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(
                            '<strong>' + via.nome + '</strong></br>' +
                            'Lei/data: ' + via.leidata + '</br>' +
                            'Cx.da via: ' + via.largura + 'm' + ' - Passeios:' + via.passeiod + '/' + via.passeioe + 'm' + '</br>' +
                            'Código: ' + via.cod
                        )
                        .openOn(mapa);
                });
            L.geoJson(e.sourceTarget.feature, {
                style: (feature) => {
                    return {
                        weight: 5,
                        color: "#ffff00",
                        dashArray: "30 10",
                        opacity: 0.6,
                        interactive: false
                    };
                }
            }).addTo(pesquisaQvias);
            if (zoomresultado == true) {
                mapa.flyToBounds(plantaCadastralDestaque.getBounds(), {
                    maxZoom: 19
                });
            };
            zoomresultado = false;
        };

        //camada via
        function inteVia(feature, layer) {
            layer.on({
                click: pCestiloDestaqVia
            });
        };
        let viasgeom = L.esri.featureLayer({
            url: 'https://arcgis.itajai.sc.gov.br/server/rest/services/sistema_viario/FeatureServer/0/',
            fields: ['nome', 'codsecao', 'objectid'],
            minZoom: 17,
            precision: 6,
            style: (feature) => {
                return {
                    color: '#ffffff00',
                    weight: 15
                };
            },
            onEachFeature: inteVia,
        }).addTo(mapa);

        //Limites Município
        L.esri
            .featureLayer({
                url: "https://arcgis.itajai.sc.gov.br/server/rest/services/Hosted/divisas_intermunicipais_Itaja%C3%AD/FeatureServer/0",
                style: (feature) => {
                    return {
                        color: '#000000',
                        opacity: 0.5,
                        fill: false,
                        interactive: false
                    }
                }
            })
            .addTo(mapa);

        //Abrir Consulta Prévia
        $('#abrirConsultaPrevia, #abrirConsultaPreviaP').click(function () {
            if (table.rowManager.activeRows["0"] === undefined) {
                alert("Aproxime o mapa para a área de interesse para visualizar os lotes, clique sobre o lote para seleciona-lo");
            } else {
                //console.log(table.rowManager.activeRows["0"].data.inscrlig)
                window.open('https://geoitajai.github.io/geo/consultazoneamento.html#' + table.rowManager.activeRows["0"].data.inscrlig, 'ConsultaPrévia', 0, true);
            }
        });
    </script>
</body>

</html>